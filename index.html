<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Record Receipt - NBA Game Receipts</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Special+Elite&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #1a1a1a;
      font-family: 'Courier New', Courier, monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .page-title {
      color: #666;
      font-family: 'Special Elite', 'Courier New', monospace;
      font-size: 14px;
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-bottom: 30px;
    }

    .no-games {
      color: #666;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      text-align: center;
      margin-top: 60px;
    }

    .loading {
      color: #666;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin-top: 60px;
    }

    .receipts-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      max-width: 1200px;
    }

    /* Receipt paper */
    .receipt {
      background: #f5f0e8;
      width: 400px;
      padding: 30px 24px;
      position: relative;
      box-shadow:
        0 4px 6px rgba(0,0,0,0.3),
        0 10px 40px rgba(0,0,0,0.4);
      /* Torn edge effect at bottom */
      -webkit-mask-image: linear-gradient(to bottom,
        #000 calc(100% - 12px),
        transparent calc(100% - 12px)),
        url("data:image/svg+xml,%3Csvg width='320' height='12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0,12 Q4,0 8,12 Q12,0 16,12 Q20,0 24,12 Q28,0 32,12 Q36,0 40,12 Q44,0 48,12 Q52,0 56,12 Q60,0 64,12 Q68,0 72,12 Q76,0 80,12 Q84,0 88,12 Q92,0 96,12 Q100,0 104,12 Q108,0 112,12 Q116,0 120,12 Q124,0 128,12 Q132,0 136,12 Q140,0 144,12 Q148,0 152,12 Q156,0 160,12 Q164,0 168,12 Q172,0 176,12 Q180,0 184,12 Q188,0 192,12 Q196,0 200,12 Q204,0 208,12 Q212,0 216,12 Q220,0 224,12 Q228,0 232,12 Q236,0 240,12 Q244,0 248,12 Q252,0 256,12 Q260,0 264,12 Q268,0 272,12 Q276,0 280,12 Q284,0 288,12 Q292,0 296,12 Q300,0 304,12 Q308,0 312,12 Q316,0 320,12' fill='%23000'/%3E%3C/svg%3E");
      -webkit-mask-position: bottom;
      -webkit-mask-repeat: no-repeat;
      -webkit-mask-composite: source-over;
      mask-image: linear-gradient(to bottom,
        #000 calc(100% - 12px),
        transparent calc(100% - 12px)),
        url("data:image/svg+xml,%3Csvg width='320' height='12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0,12 Q4,0 8,12 Q12,0 16,12 Q20,0 24,12 Q28,0 32,12 Q36,0 40,12 Q44,0 48,12 Q52,0 56,12 Q60,0 64,12 Q68,0 72,12 Q76,0 80,12 Q84,0 88,12 Q92,0 96,12 Q100,0 104,12 Q108,0 112,12 Q116,0 120,12 Q124,0 128,12 Q132,0 136,12 Q140,0 144,12 Q148,0 152,12 Q156,0 160,12 Q164,0 168,12 Q172,0 176,12 Q180,0 184,12 Q188,0 192,12 Q196,0 200,12 Q204,0 208,12 Q212,0 216,12 Q220,0 224,12 Q228,0 232,12 Q236,0 240,12 Q244,0 248,12 Q252,0 256,12 Q260,0 264,12 Q268,0 272,12 Q276,0 280,12 Q284,0 288,12 Q292,0 296,12 Q300,0 304,12 Q308,0 312,12 Q316,0 320,12' fill='%23000'/%3E%3C/svg%3E");
      mask-position: bottom;
      mask-repeat: no-repeat;
      mask-composite: add;
      padding-bottom: 40px;
      color: #222;
      font-size: 13px;
      line-height: 1.6;
    }

    /* Subtle paper texture noise */
    .receipt::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
    }

    .receipt-header {
      text-align: center;
      margin-bottom: 8px;
    }

    .receipt-logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 8px;
      display: block;
      filter: grayscale(100%) contrast(1.5);
    }

    .receipt-team-name {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .receipt-tagline {
      font-size: 12px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: #555;
    }

    .receipt-divider {
      border: none;
      border-top: 2px dashed #aaa;
      margin: 12px 0;
    }

    .receipt-order {
      text-align: center;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .receipt-datetime {
      text-align: center;
      font-size: 12px;
      color: #444;
      margin-top: 2px;
    }

    .receipt-line-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      line-height: 1.8;
    }

    .receipt-player-name {
      text-transform: uppercase;
      letter-spacing: 0.5px;
      overflow: hidden;
      white-space: nowrap;
    }

    .receipt-player-pts {
      white-space: nowrap;
      font-weight: 600;
      padding-left: 8px;
    }

    .receipt-summary {
      margin-top: 4px;
    }

    .receipt-summary-line {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      line-height: 1.8;
    }

    .receipt-total-line {
      display: flex;
      justify-content: space-between;
      font-size: 16px;
      font-weight: 900;
      line-height: 2;
      letter-spacing: 1px;
    }

    .receipt-footer {
      text-align: center;
      margin-top: 10px;
    }

    .receipt-thanks {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .receipt-qr-link {
      display: inline-block;
      margin-bottom: 8px;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    .receipt-qr-link:hover {
      opacity: 0.6;
    }

    .receipt-qr-link img {
      display: block;
    }

    .receipt-retain {
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #888;
    }

    .date-label {
      color: #888;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      letter-spacing: 3px;
      text-transform: uppercase;
      text-align: center;
      width: 100%;
      margin: 30px 0 16px;
    }

    .date-label:first-child {
      margin-top: 0;
    }

    .receipt-score-context {
      text-align: center;
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }

    .receipt-result {
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .receipt-result.win { color: #222; }
    .receipt-result.loss { color: #999; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
</head>
<body>

  <div class="page-title">Record Receipt</div>
  <div id="content" style="display:flex;flex-direction:column;align-items:center;width:100%;max-width:1200px;"><div class="loading">Loading games...</div></div>

  <script>
    const API_BASE = 'https://site.api.espn.com/apis/site/v2/sports/basketball/nba';

    function formatDateStr(date) {
      return date.getFullYear()
        + String(date.getMonth() + 1).padStart(2, '0')
        + String(date.getDate()).padStart(2, '0');
    }

    async function fetchGamesForDate(dateStr) {
      const res = await fetch(`${API_BASE}/scoreboard?dates=${dateStr}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      return (data.events || []).filter(e => e.status.type.state === 'post');
    }

    async function init() {
      const content = document.getElementById('content');

      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      try {
        // Fetch today's and yesterday's games in parallel
        const [todayGames, yesterdayGames] = await Promise.all([
          fetchGamesForDate(formatDateStr(today)),
          fetchGamesForDate(formatDateStr(yesterday))
        ]);

        if (todayGames.length === 0 && yesterdayGames.length === 0) {
          content.innerHTML = '<div class="no-games">No finalized games from today or yesterday.<br>Check back after games wrap up.</div>';
          return;
        }

        let html = '';
        if (yesterdayGames.length > 0) {
          html += `<div class="date-label">Yesterday</div><div class="receipts-container" id="receipts-yesterday"></div>`;
        }
        if (todayGames.length > 0) {
          html += `<div class="date-label">Today</div><div class="receipts-container" id="receipts-today"></div>`;
        }
        content.innerHTML = html;

        // Load box scores and render receipts for both days in parallel
        await Promise.all([
          renderReceipts(yesterdayGames, 'receipts-yesterday'),
          renderReceipts(todayGames, 'receipts-today')
        ]);
      } catch (err) {
        content.innerHTML = `<div class="no-games">Failed to load games: ${err.message}</div>`;
      }
    }

    async function renderReceipts(games, containerId) {
      const container = document.getElementById(containerId);
      if (!container || games.length === 0) return;

      const summaries = await Promise.all(
        games.map(async (event) => {
          try {
            const res = await fetch(`${API_BASE}/summary?event=${event.id}`);
            if (!res.ok) return null;
            return { event, summary: await res.json() };
          } catch { return null; }
        })
      );

      for (const item of summaries) {
        if (!item) continue;
        const { event, summary } = item;
        const competition = event.competitions[0];

        // Only create a receipt for the winning team
        const winner = competition.competitors.find(c => c.winner);
        if (winner) {
          const opponent = competition.competitors.find(c => c.id !== winner.id);
          const receipt = buildReceipt(event, winner, opponent, summary);
          container.appendChild(receipt);
        }
      }
    }

    function buildReceipt(event, team, opponent, summary) {
      const gameDate = new Date(event.date);
      const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN',
                           'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
      const dateFormatted = `${monthNames[gameDate.getMonth()]}. ${gameDate.getDate()}, ${gameDate.getFullYear()}`;
      const timeFormatted = gameDate.toLocaleTimeString([], {
        hour: '2-digit', minute: '2-digit'
      });

      const orderNum = String(gameDate.getMonth() + 1).padStart(2, '0')
        + String(gameDate.getDate()).padStart(2, '0');

      const teamScore = parseInt(team.score);
      const opponentScore = parseInt(opponent.score);
      const won = teamScore > opponentScore;

      // Get player stats from box score
      let players = [];
      if (summary.boxscore && summary.boxscore.players) {
        const teamBox = summary.boxscore.players.find(
          p => p.team.id === team.team.id
        );
        if (teamBox && teamBox.statistics && teamBox.statistics[0]) {
          const labels = teamBox.statistics[0].labels;
          const ptsIndex = labels.indexOf('PTS');

          if (ptsIndex !== -1) {
            players = teamBox.statistics[0].athletes
              .map(a => ({
                name: a.athlete.displayName,
                pts: parseInt(a.stats[ptsIndex]) || 0
              }))
              .filter(p => p.pts >= 10)
              .sort((a, b) => b.pts - a.pts);
          }
        }
      }

      const subtotal = players.reduce((sum, p) => sum + p.pts, 0);
      const bonusBuckets = teamScore - subtotal;

      // Build receipt element
      const el = document.createElement('div');
      el.className = 'receipt';

      // Build line items HTML
      let lineItemsHTML = '';
      for (const p of players) {
        const dots = '.'.repeat(Math.max(1,
          38 - p.name.length - p.pts.toFixed(2).length
        ));
        lineItemsHTML += `
          <div class="receipt-line-item">
            <span class="receipt-player-name">${p.name.toUpperCase()}</span>
            <span class="receipt-player-pts">${p.pts.toFixed(2)}</span>
          </div>`;
      }

      // Generate QR code
      const gameUrl = `https://www.espn.com/nba/game/_/gameId/${event.id}`;
      const qr = qrcode(0, 'M');
      qr.addData(gameUrl);
      qr.make();
      const qrImgTag = qr.createImgTag(3, 0);

      el.innerHTML = `
        <div class="receipt-header">
          <img class="receipt-logo" src="${team.team.logo}" alt="${team.team.displayName}">
          <div class="receipt-team-name">${team.team.displayName}</div>
          <div class="receipt-tagline">Everyone Eats</div>
        </div>

        <hr class="receipt-divider">

        <div class="receipt-order">ORDER #${orderNum} FOR ${opponent.team.shortDisplayName.toUpperCase()}</div>
        <div class="receipt-datetime">${dateFormatted} ${timeFormatted}</div>

        <hr class="receipt-divider">

        ${lineItemsHTML}

        <hr class="receipt-divider">

        <div class="receipt-summary">
          <div class="receipt-summary-line">
            <span>SUBTOTAL</span>
            <span>${subtotal.toFixed(2)}</span>
          </div>
          <div class="receipt-summary-line">
            <span>BONUS BUCKETS</span>
            <span>${bonusBuckets.toFixed(2)}</span>
          </div>
        </div>

        <hr class="receipt-divider">

        <div class="receipt-total-line">
          <span>TOTAL</span>
          <span>${teamScore.toFixed(2)}</span>
        </div>

        <div class="receipt-result win">
          W ${teamScore} - ${opponentScore}
        </div>

        <hr class="receipt-divider">

        <div class="receipt-footer">
          <div class="receipt-thanks">Thank You For Dining!</div>
          <a class="receipt-qr-link" href="${gameUrl}" target="_blank" rel="noopener">${qrImgTag}</a>
          <div class="receipt-retain">Scan For Full Box Score</div>
        </div>
      `;

      return el;
    }

    init();
  </script>

</body>
</html>
