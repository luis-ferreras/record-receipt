const API_BASE='https://site.api.espn.com/apis/site/v2/sports/basketball/nba';const receiptStore={};const printerAudio=new Audio('receipt-printer.mp3');function playPrinterSound(){printerAudio.currentTime=0;printerAudio.play()}function stopPrinterSound(){printerAudio.pause();printerAudio.currentTime=0}function formatDateStr(d){return d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0')}async function fetchGamesForDate(dateStr){const r=await fetch(`${API_BASE}/scoreboard?dates=${dateStr}`);if(!r.ok)throw new Error(`HTTP ${r.status}`);const d=await r.json();return(d.events||[]).filter(e=>e.status.type.state==='post')}function getWeekDaysBefore(yesterday){const days=[];const dayOfWeek=yesterday.getDay();const mondayOffset=dayOfWeek===0?6:dayOfWeek-1;const limit=Math.min(mondayOffset,3);for(let i=1;i<=limit;i++){const d=new Date(yesterday);d.setDate(d.getDate()-i);days.push(d)}return days}async function init(){const content=document.getElementById('content');content.innerHTML='<div class="loading">Loading games...</div>';const today=new Date(),yesterday=new Date(today);yesterday.setDate(yesterday.getDate()-1);const earlierDays=getWeekDaysBefore(yesterday);try{const[todayGames,yesterdayGames,...earlierResults]=await Promise.all([fetchGamesForDate(formatDateStr(today)),fetchGamesForDate(formatDateStr(yesterday)),...earlierDays.map(d=>fetchGamesForDate(formatDateStr(d)))]);const earlierByDay=earlierDays.map((d,i)=>({date:d,games:earlierResults[i]})).filter(entry=>entry.games.length>0);const allGames=[...yesterdayGames,...todayGames,...earlierResults.flat()];if(!todayGames.length&&!yesterdayGames.length&&!earlierByDay.length){content.innerHTML='<div class="no-games">No finalized games from today or yesterday.<br>Check back after games wrap up.</div>';return}await loadAllReceipts(allGames);renderKeyboard(yesterdayGames,todayGames,earlierByDay);openFromHash()}catch(err){content.innerHTML=`<div class="no-games">Failed to load games: ${err.message}</div>`}}async function loadAllReceipts(games){const summaries=await Promise.all(games.map(async event=>{try{const r=await fetch(`${API_BASE}/summary?event=${event.id}`);if(!r.ok)return null;return{event,summary:await r.json()}}catch{return null}}));for(const item of summaries){if(!item)continue;const{event,summary}=item,comp=event.competitions[0],winner=comp.competitors.find(c=>c.winner);if(winner){const opponent=comp.competitors.find(c=>c.id!==winner.id),gd=new Date(event.date),orderNum=String(gd.getMonth()+1).padStart(2,'0')+String(gd.getDate()).padStart(2,'0');const teamColor=winner.team.color?'#'+winner.team.color:null;receiptStore[winner.team.abbreviation+'-'+orderNum]={el:buildReceipt(event,winner,opponent,summary),teamName:winner.team.shortDisplayName,teamLogo:winner.team.logo,teamAbbrev:winner.team.abbreviation,score:`${winner.score}-${opponent.score}`,orderNum,teamColor}}}}function formatDayLabel(d){const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];return days[d.getDay()]}function renderKeyboard(yesterdayGames,todayGames,earlierByDay){const content=document.getElementById('content');let html='';const todayKeys=getWinnerKeys(todayGames);const yesterdayKeys=getWinnerKeys(yesterdayGames);const hasTodayGames=todayKeys.length>0;if(hasTodayGames){html+=`<div class="date-label">Todays Games</div><div class="keyboard">${todayKeys.map(buildKey).join('')}</div>`}if(!hasTodayGames&&yesterdayKeys.length){html+=`<div class="date-label">Yesterdays Games</div><div class="keyboard">${yesterdayKeys.map(buildKey).join('')}</div>`}const earlierEntries=earlierByDay?[...earlierByDay]:[];if(hasTodayGames&&yesterdayGames.length){const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);earlierEntries.unshift({date:yesterday,games:yesterdayGames})}if(earlierEntries.length){let dayGroups='';for(const entry of earlierEntries){const keys=getWinnerKeys(entry.games);if(keys.length){dayGroups+=`<div class="day-group"><div class="day-group-label">${formatDayLabel(entry.date)}</div><div class="keyboard keyboard-sm">${keys.map(k=>buildKey(k,true)).join('')}</div></div>`}}if(dayGroups)html+=`<div class="date-label">Earlier This Week</div><div class="previous-games-grid">${dayGroups}</div>`}content.innerHTML=html}function getWinnerKeys(games){const keys=[];for(const event of games){const comp=event.competitions[0],winner=comp.competitors.find(c=>c.winner);if(winner){const gd=new Date(event.date),orderNum=String(gd.getMonth()+1).padStart(2,'0')+String(gd.getDate()).padStart(2,'0'),key=winner.team.abbreviation+'-'+orderNum;if(receiptStore[key])keys.push(receiptStore[key])}}return keys}function buildKey(t,small){const k=`${t.teamAbbrev}-${t.orderNum}`;const colorAttr=t.teamColor?` data-team-color style="--team-color:${t.teamColor}"`:'';const closeClass='';const smClass=small?' key-sm':'';return`<button class="key${closeClass}${smClass}" onclick="showReceipt('${k}')" data-team-id="${k}"${colorAttr}><img class="key-logo" src="${t.teamLogo}" alt="${t.teamName}"><span class="key-name">${t.teamAbbrev}</span><span class="key-score">${t.score}</span></button>`}function showReceipt(receiptKey){const entry=receiptStore[receiptKey];if(!entry)return;const overlay=document.getElementById('receipt-overlay'),slide=document.getElementById('receipt-slide');overlay.classList.remove('closing');slide.innerHTML='';slide.appendChild(entry.el.cloneNode(true));document.querySelectorAll('.key').forEach(k=>k.classList.remove('key-active'));const ak=document.querySelector(`.key[data-team-id="${receiptKey}"]`);if(ak)ak.classList.add('key-active');history.replaceState(null,'',`#${receiptKey}`);overlay.classList.remove('visible');void overlay.offsetHeight;overlay.classList.add('visible');playPrinterSound();const lines=slide.querySelectorAll('.receipt-line-item,.receipt-line-extra');lines.forEach((line,i)=>{line.classList.remove('printed');setTimeout(()=>line.classList.add('printed'),1800+i*120)})}function closeReceipt(){stopPrinterSound();const overlay=document.getElementById('receipt-overlay');overlay.classList.add('closing');document.querySelectorAll('.key').forEach(k=>k.classList.remove('key-active'));history.replaceState(null,'',location.pathname+location.search);setTimeout(()=>{overlay.classList.remove('visible','closing')},500)}document.getElementById('receipt-overlay').addEventListener('click',e=>{if(!e.target.closest('.receipt'))closeReceipt()});document.addEventListener('keydown',e=>{if(e.key==='Escape')closeReceipt()});async function openFromHash(){const hash=location.hash.slice(1).toUpperCase();if(!hash)return;if(receiptStore[hash]){showReceipt(hash);return}const m=hash.match(/^([A-Z]+)-(\d{2})(\d{2})$/);if(!m)return;const[,abbrev,mm,dd]=m,now=new Date();let year=now.getFullYear();if(new Date(year,parseInt(mm)-1,parseInt(dd))>now)year--;try{const games=await fetchGamesForDate(`${year}${mm}${dd}`);if(games.length)await loadAllReceipts(games);if(receiptStore[hash])showReceipt(hash)}catch{}}window.addEventListener('hashchange',openFromHash);function getTagline(teamScore,oppScore,players,allPlayers){const margin=teamScore-oppScore;const max=players.length?Math.max(...players.map(p=>p.pts)):0;const tripleDouble=allPlayers.some(p=>p.pts>=10&&p.ast>=10&&p.reb>=10);const doubleDoubles=allPlayers.filter(p=>{const dds=[p.pts,p.ast,p.reb,p.blk,p.stl].filter(v=>v>=10);return dds.length>=2}).length;const twentyClub=players.filter(p=>p.pts>=20).length;const totalAst=allPlayers.reduce((s,p)=>s+p.ast,0);const totalReb=allPlayers.reduce((s,p)=>s+p.reb,0);const totalBlk=allPlayers.reduce((s,p)=>s+p.blk,0);const totalStl=allPlayers.reduce((s,p)=>s+p.stl,0);const topTwo=players.length>=2?players[0].pts+players[1].pts:0;if(max>=50)return'Off The Menu';if(tripleDouble)return'Triple Double Special';if(max>=40)return"Chef's Special";if(teamScore>=140)return'All You Can Eat';if(margin>=25)return'Cleared The Table';if(topTwo>=65)return'Two Course Combo';if(twentyClub>=3)return'Family Style';if(teamScore>=130)return'Buffet Mode';if(totalAst>=30)return'Table Service';if(doubleDoubles>=3)return'Double Stuffed';if(players.length>=6)return'Full Course Meal';if(max>=teamScore*0.35)return'House Special';if(totalReb>=50)return'Bussing The Tables';if(totalBlk>=7)return'Sent It All Back';if(totalStl>=10)return'Sticky Fingers Night';if(oppScore<90)return'Clean Plate Club';if(teamScore+oppScore>=240)return'Feast Mode';if(teamScore>=120)return'Served Hot';if(margin>=15)return'Second Helpings';if(margin<=3)return'Last Call';if(margin<=6)return'Earned Every Bite';if(margin<=10)return'Slow Cooked';return'Everyone Eats'}function buildReceipt(event,team,opponent,summary){const gd=new Date(event.date),months=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'],dateFmt=`${months[gd.getMonth()]}. ${gd.getDate()}, ${gd.getFullYear()}`,timeFmt=gd.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),orderNum=String(gd.getMonth()+1).padStart(2,'0')+String(gd.getDate()).padStart(2,'0'),teamScore=parseInt(team.score),oppScore=parseInt(opponent.score);let players=[],allPlayers=[];if(summary.boxscore?.players){const tb=summary.boxscore.players.find(p=>p.team.id===team.team.id);if(tb?.statistics?.[0]){const labels=tb.statistics[0].labels,pi=labels.indexOf('PTS'),ai=labels.indexOf('AST'),ri=labels.indexOf('REB'),bi=labels.indexOf('BLK'),si=labels.indexOf('STL');if(pi!==-1){allPlayers=tb.statistics[0].athletes.map(a=>({name:a.athlete.displayName,pts:parseInt(a.stats[pi])||0,ast:ai!==-1?(parseInt(a.stats[ai])||0):0,reb:ri!==-1?(parseInt(a.stats[ri])||0):0,blk:bi!==-1?(parseInt(a.stats[bi])||0):0,stl:si!==-1?(parseInt(a.stats[si])||0):0}));players=allPlayers.filter(p=>p.pts>=10).sort((a,b)=>b.pts-a.pts)}}}const subtotal=players.reduce((s,p)=>s+p.pts,0),bonus=teamScore-subtotal,el=document.createElement('div');el.className='receipt';const rotation=((Math.random()*2-1)*0.6).toFixed(2);el.style.setProperty('--receipt-rotation',rotation+'deg');let items='';for(const p of players){items+=`<div class="receipt-line-item"><span class="receipt-player-name">${p.name.toUpperCase()}</span><span class="receipt-player-pts">${p.pts.toFixed(2)}</span></div>`;const extras=[];if(p.ast>=15)extras.push({label:'Michelin Star Service',val:p.ast,stat:'AST'});else if(p.ast>=12)extras.push({label:'Table Captain',val:p.ast,stat:'AST'});else if(p.ast>8)extras.push({label:'Extra Dish',val:p.ast,stat:'AST'});if(p.reb>=15)extras.push({label:'All You Can Carry',val:p.reb,stat:'REB'});else if(p.reb>=12)extras.push({label:'Doggy Bag',val:p.reb,stat:'REB'});else if(p.reb>8)extras.push({label:'Leftovers',val:p.reb,stat:'REB'});if(p.blk>=6)extras.push({label:"Kitchen's Closed",val:p.blk,stat:'BLK'});else if(p.blk>3)extras.push({label:'Sent It Back',val:p.blk,stat:'BLK'});if(p.stl>=6)extras.push({label:'Picked Clean',val:p.stl,stat:'STL'});else if(p.stl>3)extras.push({label:'Sticky Fingers',val:p.stl,stat:'STL'});for(const x of extras)items+=`<div class="receipt-line-extra">${x.label} @ ${x.val}/${x.stat}</div>`}const url=`https://www.espn.com/nba/game/_/gameId/${event.id}`,qrSrc=`https://api.qrserver.com/v1/create-qr-code/?size=128x128&data=${encodeURIComponent(url)}`;el.innerHTML=`<div class="receipt-header"><img class="receipt-logo" src="${team.team.logo}" alt="${team.team.displayName}"><div class="receipt-team-name">${team.team.displayName}</div><div class="receipt-tagline">${getTagline(teamScore,oppScore,players,allPlayers)}</div></div><div class="receipt-order">ORDER #${orderNum} FOR ${opponent.team.shortDisplayName.toUpperCase()}</div><div class="receipt-datetime">${dateFmt} ${timeFmt}</div><hr class="receipt-divider">${items}<hr class="receipt-divider"><div class="receipt-summary"><div class="receipt-summary-line"><span>SUBTOTAL</span><span>${subtotal.toFixed(2)}</span></div><div class="receipt-summary-line"><span>BONUS BUCKETS</span><span>${bonus.toFixed(2)}</span></div></div><div class="receipt-total-line"><span>TOTAL</span><span>${teamScore.toFixed(2)}</span></div><div class="receipt-footer"><div class="receipt-thanks">Thank You For Dining!</div><a class="receipt-qr-link" href="${url}" target="_blank" rel="noopener"><img src="${qrSrc}" alt="QR Code" onerror="this.style.display='none'"></a><div class="receipt-result win">W ${teamScore} - ${oppScore}</div></div><div class="receipt-thermal-fade"></div><div class="receipt-paper-curl"></div>`;return el}init();