const API_BASE='https://site.api.espn.com/apis/site/v2/sports/basketball/nba';const receiptStore={};const printerAudio=new Audio('receipt-printer.mp3');function playPrinterSound(){printerAudio.currentTime=0;printerAudio.play()}function stopPrinterSound(){printerAudio.pause();printerAudio.currentTime=0}function formatDateStr(d){return d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0')}async function fetchGamesForDate(dateStr){const r=await fetch(`${API_BASE}/scoreboard?dates=${dateStr}`);if(!r.ok)throw new Error(`HTTP ${r.status}`);const d=await r.json();return(d.events||[]).filter(e=>e.status.type.state==='post')}async function init(){const content=document.getElementById('content');content.innerHTML='<div class="loading">Loading games...</div>';const today=new Date(),yesterday=new Date(today);yesterday.setDate(yesterday.getDate()-1);try{const[todayGames,yesterdayGames]=await Promise.all([fetchGamesForDate(formatDateStr(today)),fetchGamesForDate(formatDateStr(yesterday))]);if(!todayGames.length&&!yesterdayGames.length){content.innerHTML='<div class="no-games">No finalized games from today or yesterday.<br>Check back after games wrap up.</div>';return}await loadAllReceipts([...yesterdayGames,...todayGames]);renderKeyboard(yesterdayGames,todayGames);openFromHash()}catch(err){content.innerHTML=`<div class="no-games">Failed to load games: ${err.message}</div>`}}async function loadAllReceipts(games){const summaries=await Promise.all(games.map(async event=>{try{const r=await fetch(`${API_BASE}/summary?event=${event.id}`);if(!r.ok)return null;return{event,summary:await r.json()}}catch{return null}}));for(const item of summaries){if(!item)continue;const{event,summary}=item,comp=event.competitions[0],winner=comp.competitors.find(c=>c.winner);if(winner){const opponent=comp.competitors.find(c=>c.id!==winner.id),gd=new Date(event.date),orderNum=String(gd.getMonth()+1).padStart(2,'0')+String(gd.getDate()).padStart(2,'0');receiptStore[winner.team.abbreviation+'-'+orderNum]={el:buildReceipt(event,winner,opponent,summary),teamName:winner.team.shortDisplayName,teamLogo:winner.team.logo,teamAbbrev:winner.team.abbreviation,score:`${winner.score}-${opponent.score}`,orderNum}}}}function renderKeyboard(yesterdayGames,todayGames){const content=document.getElementById('content');let html='';if(todayGames.length){const keys=getWinnerKeys(todayGames);if(keys.length)html+=`<div class="date-label">Todays Games</div><div class="keyboard">${keys.map(buildKey).join('')}</div>`}if(yesterdayGames.length){const keys=getWinnerKeys(yesterdayGames);if(keys.length)html+=`<div class="date-label">Yesterdays Games</div><div class="keyboard">${keys.map(buildKey).join('')}</div>`}content.innerHTML=html}function getWinnerKeys(games){const keys=[];for(const event of games){const comp=event.competitions[0],winner=comp.competitors.find(c=>c.winner);if(winner){const gd=new Date(event.date),orderNum=String(gd.getMonth()+1).padStart(2,'0')+String(gd.getDate()).padStart(2,'0'),key=winner.team.abbreviation+'-'+orderNum;if(receiptStore[key])keys.push(receiptStore[key])}}return keys}function buildKey(t){const k=`${t.teamAbbrev}-${t.orderNum}`;return`<button class="key" onclick="showReceipt('${k}')" data-team-id="${k}"><img class="key-logo" src="${t.teamLogo}" alt="${t.teamName}"><span class="key-name">${t.teamAbbrev}</span><span class="key-score">${t.score}</span></button>`}function showReceipt(receiptKey){const entry=receiptStore[receiptKey];if(!entry)return;const overlay=document.getElementById('receipt-overlay'),slide=document.getElementById('receipt-slide');slide.innerHTML='';slide.appendChild(entry.el.cloneNode(true));document.querySelectorAll('.key').forEach(k=>k.classList.remove('key-active'));const ak=document.querySelector(`.key[data-team-id="${receiptKey}"]`);if(ak)ak.classList.add('key-active');history.replaceState(null,'',`#${receiptKey}`);overlay.classList.remove('visible');void overlay.offsetHeight;overlay.classList.add('visible');playPrinterSound()}function closeReceipt(){stopPrinterSound();document.getElementById('receipt-overlay').classList.remove('visible');document.querySelectorAll('.key').forEach(k=>k.classList.remove('key-active'));history.replaceState(null,'',location.pathname+location.search)}document.getElementById('receipt-overlay').addEventListener('click',e=>{if(!e.target.closest('.receipt'))closeReceipt()});document.addEventListener('keydown',e=>{if(e.key==='Escape')closeReceipt()});async function openFromHash(){const hash=location.hash.slice(1).toUpperCase();if(!hash)return;if(receiptStore[hash]){showReceipt(hash);return}const m=hash.match(/^([A-Z]+)-(\d{2})(\d{2})$/);if(!m)return;const[,abbrev,mm,dd]=m,now=new Date();let year=now.getFullYear();if(new Date(year,parseInt(mm)-1,parseInt(dd))>now)year--;try{const games=await fetchGamesForDate(`${year}${mm}${dd}`);if(games.length)await loadAllReceipts(games);if(receiptStore[hash])showReceipt(hash)}catch{}}window.addEventListener('hashchange',openFromHash);function getTagline(teamScore,oppScore,players,allPlayers){const margin=teamScore-oppScore;const max=players.length?Math.max(...players.map(p=>p.pts)):0;const tripleDouble=allPlayers.some(p=>p.pts>=10&&p.ast>=10&&p.reb>=10);const twentyClub=players.filter(p=>p.pts>=20).length;const totalAst=allPlayers.reduce((s,p)=>s+p.ast,0);const totalBlk=allPlayers.reduce((s,p)=>s+p.blk,0);const totalStl=allPlayers.reduce((s,p)=>s+p.stl,0);if(max>=50)return'Record Breaker';if(tripleDouble)return'Triple Double Special';if(max>=40)return"Chef's Special";if(teamScore>=140)return'All You Can Eat';if(margin>=25)return'Cleared The Table';if(twentyClub>=3)return'Family Style';if(totalAst>=30)return'Sharing Is Caring';if(players.length>=6)return'Full Course Meal';if(totalBlk>=7)return'Sent It All Back';if(totalStl>=10)return'Sticky Fingers Night';if(margin<=3)return'Down To The Wire';if(margin<=6)return'Earned Every Bite';return'Everyone Eats'}function buildReceipt(event,team,opponent,summary){const gd=new Date(event.date),months=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'],dateFmt=`${months[gd.getMonth()]}. ${gd.getDate()}, ${gd.getFullYear()}`,timeFmt=gd.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),orderNum=String(gd.getMonth()+1).padStart(2,'0')+String(gd.getDate()).padStart(2,'0'),teamScore=parseInt(team.score),oppScore=parseInt(opponent.score);let players=[],allPlayers=[];if(summary.boxscore?.players){const tb=summary.boxscore.players.find(p=>p.team.id===team.team.id);if(tb?.statistics?.[0]){const labels=tb.statistics[0].labels,pi=labels.indexOf('PTS'),ai=labels.indexOf('AST'),ri=labels.indexOf('REB'),bi=labels.indexOf('BLK'),si=labels.indexOf('STL');if(pi!==-1){allPlayers=tb.statistics[0].athletes.map(a=>({name:a.athlete.displayName,pts:parseInt(a.stats[pi])||0,ast:ai!==-1?(parseInt(a.stats[ai])||0):0,reb:ri!==-1?(parseInt(a.stats[ri])||0):0,blk:bi!==-1?(parseInt(a.stats[bi])||0):0,stl:si!==-1?(parseInt(a.stats[si])||0):0}));players=allPlayers.filter(p=>p.pts>=10).sort((a,b)=>b.pts-a.pts)}}}const subtotal=players.reduce((s,p)=>s+p.pts,0),bonus=teamScore-subtotal,el=document.createElement('div');el.className='receipt';let items='';for(const p of players){items+=`<div class="receipt-line-item"><span class="receipt-player-name">${p.name.toUpperCase()}</span><span class="receipt-player-pts">${p.pts.toFixed(2)}</span></div>`;const extras=[];if(p.ast>8)extras.push({label:'Extra Dish',val:p.ast,stat:'AST'});if(p.reb>8)extras.push({label:'Leftovers',val:p.reb,stat:'REB'});if(p.blk>3)extras.push({label:'Sent It Back',val:p.blk,stat:'BLK'});if(p.stl>3)extras.push({label:'Sticky Fingers',val:p.stl,stat:'STL'});for(const x of extras)items+=`<div class="receipt-line-extra">${x.label} @ ${x.val}/${x.stat}</div>`}const url=`https://www.espn.com/nba/game/_/gameId/${event.id}`,qr=qrcode(0,'M');qr.addData(url);qr.make();el.innerHTML=`<div class="receipt-header"><img class="receipt-logo" src="${team.team.logo}" alt="${team.team.displayName}"><div class="receipt-team-name">${team.team.displayName}</div><div class="receipt-tagline">${getTagline(teamScore,oppScore,players,allPlayers)}</div></div><div class="receipt-order">ORDER #${orderNum} FOR ${opponent.team.shortDisplayName.toUpperCase()}</div><div class="receipt-datetime">${dateFmt} ${timeFmt}</div><hr class="receipt-divider">${items}<hr class="receipt-divider"><div class="receipt-summary"><div class="receipt-summary-line"><span>SUBTOTAL</span><span>${subtotal.toFixed(2)}</span></div><div class="receipt-summary-line"><span>BONUS BUCKETS</span><span>${bonus.toFixed(2)}</span></div></div><div class="receipt-total-line"><span>TOTAL</span><span>${teamScore.toFixed(2)}</span></div><div class="receipt-result win">W ${teamScore} - ${oppScore}</div><div class="receipt-footer"><div class="receipt-thanks">Thank You For Dining!</div><a class="receipt-qr-link" href="${url}" target="_blank" rel="noopener">${qr.createImgTag(3,0)}</a><div class="receipt-retain">Scan For Full Box Score</div></div>`;return el}init();